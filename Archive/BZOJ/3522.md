## 题意

给定一棵树，选3个点，求两两之间距离相同且大于0的方案数。

$n \le 10^5$。

## 思路

先考虑一个暴力做法。

设 $f_{u,d}$ 为 $u$ 子树中与 $u$ 的距离为 $d$ 的点数。那么 $f_{u,0}=1,f_{u,d}=\sum f_{v,d-1}$。

设 $g_{u,d}$ 为 $u$ 子树中满足以下条件的点对 $(x,y)$ 数量。

- 记 $p=lca(x,y)$
- $dis(x,p)=dis(y,p)=t$
- $t-dis(u,p)=d$

也就是子树外找一个距离 $u$ 为 $d$ 的点可组成合法三元组的子树内点对数量。

那么 $g_{u,d}=\sum_{x \not = y} f_{x,d} \times f_{y,d} + \sum g_{v,d+1}$。

考虑答案的计算。在 $u$ 点可以统计到 $lca(x,y,z)=u$ 的合法方案数。设 $x$ 是 $u$ 的子节点，那么贡献就为 $g_{x,d} \times \sum_{y \not = x} f_{y,d-1}$，即子树内两个点加上子树外的一个点。

显然，上述算法的复杂度是 $\mathcal{O}(n^2)$ 的，考虑如何用长链剖分优化。

加速 $f$ 和 $g$ 的后半部分转移是长链剖的经典操作，可以直接维护。$g$ 的前半部分转移只要在维护 $f$ 合并时边合并边计算即可。

分类讨论计算答案。对于 $g$ 来自重儿子的情况，可以在执行轻儿子的 $f$ 合并时一并计算。对于 $g$ 来自轻儿子的情况，先维护完成整棵子树的信息，然后枚举所有的轻儿子，此时整棵树的 $f$ 都已经算出来，只要再减去对应轻儿子的 $f$ 即可得到 $\sum_{y \not = x} f_{y,d-1}$。

于是，我们便得到了一个 $\mathcal{O}(n)$ 的做法。